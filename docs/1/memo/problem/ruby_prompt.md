# ルビ入力プロンプトの問題

* 修正できない
* フリガナを全削除するとゴミタグが残る

## 修正できない

　本コードはHTMLの`contenteditable`属性を使ってルビを入力させるものである。

　今の実装には問題がある。現状、選択したテキストの要素が`<ruby>`であれば、ルビ入力させないようにしてある。ネストを回避するためだ。`<ruby>`の中に`<ruby>`が入ってしまうのである。これを防ぐための簡易的な処置だ。しかしこれには問題がある。

　ルビの修正ができない。間違えてルビを振ってしまい、振り直したい。だが、すでに`<ruby>`タグが振られている。今の実装では選択したテキストの要素が`<ruby>`のとき、ルビ入力できない仕様だ。一度つけたルビは修正できない。

* ルビの範囲が広すぎた：もう二度と修正できない

## フリガナを全削除するとゴミタグが残る

　`<ruby>`とそれより前の1字以上のテキストを選択してルビを振り直すと、旧ルビがゴミタグとして残ってしまう。

### パターン

　ルビとテキスト選択範囲の組合せパターン。

* 選択テキストがプレーンテキストである（`<ruby>`タグが含まれていない）
* 選択テキストが`<ruby>選択テキスト<rt>せんたくてきすと<rt></ruby>`である
* 選択テキストの一部に`<ruby>`が含まれている
    * 前　：旧ルビが残る。`<ruby><rt>フリガナ</rt></ruby>`。親文字は消える。
    * 前後：（同上）
    * 後　：（入力できない）

### 問題パターンは２つ

　すでに`<ruby>`が含まれている部分に加え、それより前にあるテキストも範囲選択したとき、ゴミタグが残ってしまう。

* 選択テキストの一部に`<ruby>`が含まれている
    * 前　：旧ルビが残る。`<ruby><rt>フリガナ</rt></ruby>`。親文字は消える。
    * 前後：（同上）

# 解決

　選択テキストの内容次第で処理を変える。

選択テキストの内容|処理
------------------|----
プレーンテキストである（`<ruby>`タグなし）|`<ruby>`を新規作成する
`<ruby>...</ruby>`である（過不足なく丁度）|`<ruby>`を変更する
一部に`<ruby>`を含む（前）|旧`<ruby>`を削除し、`<ruby>`を新規作成する
一部に`<ruby>`を含む（後）|旧`<ruby>`を削除し、`<ruby>`を新規作成する
一部に`<ruby>`を含む（前後）|旧`<ruby>`を削除し、`<ruby>`を新規作成する

　以下のような処理が必要だとわかった。

* 新規作成
* `<rt>`のテキストノードのみ修正
* 旧`<ruby>`を削除する

## 旧`<ruby>`を削除する

1. 選択範囲の子孫ノードを取得する
1. 1のうち`<ruby>`なら削除する

* 選択要素を削除する：[Range.deleteContents()][]
* 選択テキストを取得する：`window.getSelection().toString()`

[Range.deleteContents()]:https://developer.mozilla.org/en-US/docs/Web/API/Range/deleteContents


　問題は選択テキスト。このままではルビのフリガナまで含まれてしまう。選択テキストからフリガナだけを除外したい。

